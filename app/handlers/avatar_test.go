package handlers_test

import (
	"io/ioutil"
	"net/http"
	"testing"

	"github.com/getfider/fider/app/pkg/mock"

	"github.com/getfider/fider/app/handlers"
	. "github.com/onsi/gomega"
)

func TestAvatarHandler(t *testing.T) {
	RegisterTestingT(t)

	server, _ := mock.NewServer()
	code, response := server.
		OnTenant(mock.DemoTenant).
		AsUser(mock.JonSnow).
		AddParam("size", 50).
		AddParam("name", "Jon Snow").
		Execute(handlers.LetterAvatar())

	expectedAvatar := []byte{
		137, 80, 78, 71, 13, 10, 26, 10, 0, 0, 0, 13, 73, 72, 68, 82, 0, 0, 0, 50, 0, 0, 0, 50, 8, 2, 0, 0, 0, 145,
		93, 31, 230, 0, 0, 2, 150, 73, 68, 65, 84, 120, 156, 236, 152, 91, 79, 226, 64, 20, 128, 167, 115, 233, 141,
		94, 160, 84, 164, 46, 198, 93, 55, 217, 248, 255, 255, 200, 190, 154, 189, 100, 141, 138, 130, 86, 64, 218,
		210, 206, 244, 182, 129, 106, 117, 163, 49, 51, 89, 34, 62, 204, 247, 212, 28, 79, 207, 124, 158, 30, 78, 9,
		248, 251, 233, 47, 240, 241, 128, 187, 22, 120, 29, 169, 37, 130, 212, 18, 65, 106, 137, 32, 181, 68, 144, 90,
		34, 72, 45, 17, 164, 150, 8, 82, 75, 4, 252, 63, 55, 219, 29, 115, 224, 117, 1, 0, 227, 105, 152, 49, 214, 4,
		33, 132, 126, 215, 113, 172, 142, 70, 214, 197, 243, 162, 140, 146, 85, 184, 88, 230, 69, 241, 78, 90, 24, 161,
		142, 174, 53, 42, 77, 132, 16, 124, 252, 105, 168, 17, 210, 230, 32, 21, 234, 170, 235, 185, 246, 217, 213, 52,
		73, 179, 247, 208, 122, 201, 104, 224, 107, 132, 212, 0, 220, 220, 45, 238, 147, 164, 174, 129, 169, 107, 67, 191,
		71, 16, 58, 10, 246, 79, 207, 46, 170, 170, 226, 169, 179, 205, 217, 66, 8, 218, 166, 1, 0, 88, 44, 227, 233, 108,
		158, 81, 70, 25, 155, 47, 163, 203, 105, 184, 105, 45, 116, 173, 14, 103, 169, 109, 118, 75, 81, 148, 230, 162,
		252, 183, 37, 73, 154, 221, 221, 71, 155, 120, 185, 3, 173, 162, 40, 105, 158, 107, 132, 120, 174, 157, 164,
		217, 125, 156, 52, 241, 170, 170, 198, 55, 161, 80, 169, 45, 47, 136, 241, 205, 93, 93, 3, 168, 40, 71, 193,
		224, 219, 209, 104, 224, 117, 213, 103, 227, 191, 51, 173, 120, 149, 254, 190, 188, 74, 233, 122, 89, 232,
		42, 25, 246, 123, 39, 159, 71, 199, 163, 192, 212, 245, 93, 106, 1, 0, 86, 25, 253, 121, 62, 254, 51, 158,
		204, 163, 184, 25, 50, 203, 208, 191, 30, 6, 125, 215, 225, 47, 178, 229, 5, 209, 18, 173, 210, 104, 149,
		66, 69, 113, 237, 78, 224, 123, 24, 161, 131, 65, 63, 78, 51, 250, 184, 117, 223, 134, 183, 91, 16, 66,
		140, 16, 70, 232, 121, 80, 121, 186, 172, 1, 0, 134, 166, 117, 109, 171, 107, 91, 237, 71, 178, 170, 235,
		249, 50, 62, 159, 220, 54, 201, 174, 101, 114, 30, 199, 219, 45, 191, 235, 12, 251, 61, 0, 192, 233, 217,
		5, 203, 31, 94, 35, 132, 60, 220, 94, 148, 155, 135, 101, 26, 129, 191, 206, 249, 113, 206, 50, 250, 212,
		149, 246, 26, 65, 238, 46, 112, 230, 165, 143, 165, 219, 17, 33, 24, 123, 142, 221, 188, 245, 88, 158,
		3, 0, 150, 73, 82, 111, 254, 116, 176, 215, 111, 251, 170, 40, 74, 191, 251, 112, 75, 198, 114, 206,
		227, 120, 187, 21, 175, 210, 148, 50, 67, 83, 247, 122, 174, 99, 153, 121, 81, 26, 154, 134, 224, 250,
		97, 93, 135, 179, 38, 135, 178, 124, 18, 206, 2, 223, 179, 12, 253, 228, 203, 97, 70, 89, 89, 85, 154,
		74, 84, 140, 155, 127, 108, 17, 197, 156, 199, 41, 252, 191, 111, 97, 140, 70, 131, 61, 167, 99, 180,
		145, 162, 172, 38, 225, 108, 182, 140, 158, 167, 57, 29, 115, 223, 239, 25, 170, 218, 70, 106, 0, 22,
		81, 124, 125, 59, 43, 74, 222, 45, 47, 160, 213, 160, 18, 172, 107, 42, 84, 96, 94, 20, 105, 70, 171,
		186, 126, 53, 109, 221, 36, 66, 16, 132, 69, 89, 102, 148, 241, 11, 53, 8, 47, 8, 150, 23, 237, 200,
		191, 1, 101, 57, 229, 158, 164, 151, 124, 208, 111, 167, 82, 75, 4, 169, 37, 130, 212, 18, 65, 106, 137,
		32, 181, 68, 144, 90, 34, 72, 45, 17, 254, 6, 0, 0, 255, 255, 195, 184, 4, 70, 45, 232, 84, 206, 0,
		0, 0, 0, 73, 69, 78, 68, 174, 66, 96, 130}

	Expect(code).To(Equal(http.StatusOK))
	Expect(ioutil.ReadAll(response.Body)).To(Equal(expectedAvatar))
}
