package main

import (
	"fmt"
	"os"
	"runtime"

	"github.com/getfider/fider/app/cmd"
	"github.com/getfider/fider/app/models"
	"github.com/getfider/fider/app/pkg/env"
	_ "github.com/lib/pq"
	"rogchap.com/v8go"
)

var (
	// replaced during CI build
	buildtime   = ""
	buildnumber = "local"

	// Use this for non-stable releases
	// version = "x.y.z-" + buildnumber

	// Use this for stable releases
	// version = "x.y.z"

	version = "0.19.0-" + buildnumber
)

func main() {
	settings := &models.SystemSettings{
		BuildTime:       buildtime,
		Version:         version,
		Compiler:        runtime.Version(),
		Environment:     env.Config.Environment,
		GoogleAnalytics: env.Config.GoogleAnalytics,
		Mode:            env.Config.HostMode,
		Domain:          env.MultiTenantDomain(),
		HasLegal:        env.HasLegal(),
	}

	args := os.Args[1:]
	if len(args) > 0 && args[0] == "ping" {
		os.Exit(cmd.RunPing())
	} else if len(args) > 0 && args[0] == "migrate" {
		os.Exit(cmd.RunMigrate())
	} else if len(args) > 0 && args[0] == "ssr" {
		bytes, err := os.ReadFile("ssr.js")
		if err != nil {
			panic(err)
		}
		ctx, _ := v8go.NewContext()                       // creates a new V8 context with a new Isolate aka VM
		_, err = ctx.RunScript(string(bytes), "index.js") // executes a script on the global context
		if err != nil {
			panic(err)
		}

		firstArg := `{"contextID":"mFofODbmyNLw83hGlXwGeVgHr1MqgdXY","description":"Fider is an open platform to collect and prioritize product feedback. Visit getfider.com to learn more. We&#39;re on a mission to build the best feedb","settings":{"baseURL":"https://feedback.fider.io","buildTime":"2021.03.19.202147","compiler":"go1.16","domain":".fider.io","environment":"production","globalAssetsURL":"https://feedback.fider.io","googleAnalytics":"UA-100765645-1","hasLegal":true,"mode":"multi","oauth":[],"stripePublicKey":"","tenantAssetsURL":"https://feedback.fider.io","version":"0.19.0-"},"tenant":{"id":2,"name":"Feedback for Fider","subdomain":"feedback","invitation":"","welcomeMessage":"**Fider** is an open platform to collect and prioritize product feedback. Visit [getfider.com](http://getfider.com/) to learn more.\n\nWe're on a mission to build the best feedback system ever, but we know this is not possible without your help. We need your feedback on how to improve it!\n\n*For testing purposes, please use https://demo.fider.io.*\n\n#### How can we make Fider better for you?","cname":"","status":1,"isPrivate":false,"logoBlobKey":"logos/0777d5c17d4066b82ab86dff8a46af6f.png"},"title":"Feedback for Fider","user":{"avatarBlobKey":"","avatarType":"gravatar","avatarURL":"https://feedback.fider.io/avatars/gravatar/3/Guilherme%20Oenning","email":"me@goenning.net","id":3,"isAdministrator":true,"isCollaborator":true,"name":"Guilherme Oenning","role":"administrator","status":"active"}}`
		secondArg := `{"countPerStatus":{"completed":48,"declined":7,"deleted":97,"duplicate":20,"open":141,"planned":5,"started":1},"posts":[{"id":23771,"number":319,"title":"Manage Multiple API Keys","slug":"manage-multiple-api-keys","description":"Ability to manage multiple API Keys, right now it is too easy to accidentally regenerate the key\n\nShow:\nFriendly Name\nPartial Key\nRevoke Key\nRegenerate Key","createdAt":"2021-03-19T08:37:37.544238Z","user":{"id":37481,"name":"Andrew Korenkov","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37481/Andrew%20Korenkov","status":"active"},"hasVoted":false,"votesCount":1,"commentsCount":0,"status":"open","tags":[]},{"id":23760,"number":318,"title":"Make it possible to order Fider stickers and other merch","slug":"make-it-possible-to-order-fider-stickers-and-other-merch","description":"We want to be able to order great rainbow-coloured Fider stockers!","createdAt":"2021-03-16T14:13:19.736744Z","user":{"id":37452,"name":"Roman Pixell","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37452/Roman%20Pixell","status":"active"},"hasVoted":true,"votesCount":4,"commentsCount":0,"status":"open","tags":[]},{"id":23736,"number":312,"title":"Integration with WordPress","slug":"integration-with-wordpress","description":"Integration with WordPress to be easier to log in with WordPress.com or Websites using wordpress","createdAt":"2021-03-05T17:21:51.152478Z","user":{"id":37402,"name":"Sharif I.","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37402/Sharif%20I.","status":"active"},"hasVoted":false,"votesCount":4,"commentsCount":0,"status":"open","tags":[]},{"id":23751,"number":316,"title":"Private Ideas","slug":"private-ideas","description":"We have staff submit ideas and these should be able to be set \"Private\", so they can be reviewed and released to the public.\n\nThis would be an extension of the \"Private\" site idea.","createdAt":"2021-03-09T17:36:15.437711Z","user":{"id":37421,"name":"James O'Hara","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37421/James%20O%27Hara","status":"active"},"hasVoted":false,"votesCount":2,"commentsCount":0,"status":"open","tags":[]},{"id":23700,"number":310,"title":"Add a \"bug\" label","slug":"add-a-bug-label","description":"Allowing users to talk about bugs, having a \"bug\" label too.","createdAt":"2021-02-20T07:57:52.492987Z","user":{"id":37331,"name":"Manben","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37331/Manben","status":"active"},"hasVoted":false,"votesCount":5,"commentsCount":1,"status":"open","tags":[]},{"id":23754,"number":317,"title":"Ability to copy comments permalink","slug":"ability-to-copy-comments-permalink","description":"That's similar to github etc, users able to copy comments permalink from right corner of each comments drop down. Even we need to share about comment but currently we only able to copy whole topic link.","createdAt":"2021-03-11T05:44:31.997468Z","user":{"id":37370,"name":"ar","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37370/ar","status":"active"},"hasVoted":false,"votesCount":1,"commentsCount":0,"status":"open","tags":[]},{"id":23750,"number":315,"title":"Internal and External voting","slug":"internal-and-external-voting","description":"It would be great if users could be grouped and weighted. For example if a project leader suggests an idea that has a weight of 3, vs person in group A has a weight of 1.\n\nThis would be hugely helpful in taking the project from an \"ideas board\" to \"ideas management\" which includes being part of and managing a more complicated decisioning process.","createdAt":"2021-03-09T17:34:06.037537Z","user":{"id":37421,"name":"James O'Hara","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37421/James%20O%27Hara","status":"active"},"hasVoted":false,"votesCount":1,"commentsCount":0,"status":"open","tags":[]},{"id":23745,"number":314,"title":"Allow disabling email confirmation necessity (but still allow email signup)","slug":"allow-disabling-email-confirmation-necessity-but-still-allow-email-signup","description":"you want to have a low boundary for users to give feedback, and there is no reason why someone should have motivation to make bullshit on a feedback site. I think this feature is important to get more feedback (because it s easier for the user).\n\nLook, how it is solved at xodos uservoice: http://feedback.xodo.com/ I find this solution quite nice.","createdAt":"2021-03-07T16:13:55.717996Z","user":{"id":37411,"name":"argat","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37411/argat","status":"active"},"hasVoted":false,"votesCount":1,"commentsCount":0,"status":"open","tags":[]},{"id":23576,"number":304,"title":"Easier suggestion box.","slug":"easier-suggestion-box","description":"","createdAt":"2021-01-08T23:06:46.979205Z","user":{"id":37053,"name":"Dan Jimmerson","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/37053/Dan%20Jimmerson","status":"active"},"hasVoted":false,"votesCount":8,"commentsCount":1,"status":"open","tags":[]},{"id":23085,"number":294,"title":"Improve keyboard accessibility","slug":"improve-keyboard-accessibility","description":"Most of what's outlined [here](https://webaim.org/techniques/keyboard/) is minimally implemented and needs improvement.\n\nShould look into:\n- Normalize and add missing tab ordering\n- Better more prominent focus indicators\n- Add access keys for primary interfaces and flows. \n  - For example: Key \"/\" to access the feedback entry box. Just like the search box on GitHub's home page UI. \n- Add showing all keyboard shortcuts with \"?\" key","createdAt":"2020-11-08T03:34:25.096811Z","user":{"id":36080,"name":"Juan Carlos Corona Romero","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/36080/Juan%20Carlos%20Corona%20Romero","status":"active"},"hasVoted":false,"votesCount":19,"commentsCount":0,"status":"open","tags":[]},{"id":23030,"number":292,"title":"Open Graph Data Images","slug":"open-graph-data-images","description":"images for posts has been added in 0.18 but it would be great if the \"og:image\" tag can also be set to these images for individual posts","createdAt":"2020-11-01T21:37:23.11534Z","user":{"id":35969,"name":"Jesse James Jonathon PeIley","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/35969/Jesse%20James%20Jonathon%20PeIley","status":"active"},"hasVoted":false,"votesCount":5,"commentsCount":0,"status":"open","tags":[]},{"id":11157,"number":164,"title":"Allow users to edit the ideas they submitted for clarity","slug":"allow-users-to-edit-the-ideas-they-submitted-for-clarity","description":"Editing title and description is currently limited to collaborators and administrators.\nQuite often, we find ourselves asking idea authors to revise their original post for clarity, which is not possible - so we'll either have to do the edit ourselves, or the user has to re-submit the idea.","createdAt":"2019-01-23T16:18:45.181352Z","user":{"id":13030,"name":"Christian Becker","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/13030/Christian%20Becker","status":"active"},"hasVoted":false,"votesCount":41,"commentsCount":7,"status":"open","tags":[]},{"id":19598,"number":239,"title":"Allow users to add to add tags","slug":"allow-users-to-add-to-add-tags","description":"It would be great if users can select tags when submitting their feedback","createdAt":"2020-03-06T00:07:17.207601Z","user":{"id":29191,"name":"Mariam Arab","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/29191/Mariam%20Arab","status":"active"},"hasVoted":false,"votesCount":13,"commentsCount":3,"status":"open","tags":[]},{"id":16869,"number":212,"title":"Close Comments","slug":"close-comments","description":"It would be great to close comments on an item. Especially when it is declined or merged as a duplicate.","createdAt":"2019-09-11T20:07:14.668315Z","user":{"id":4697,"name":"Josh Hudnall","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/4697/Josh%20Hudnall","status":"active"},"hasVoted":true,"votesCount":11,"commentsCount":1,"status":"open","tags":[]},{"id":1738,"number":75,"title":"Add reCAPTCHA support to user creation","slug":"add-recaptcha-support-to-user-creation","description":"This would be very helpful to potentially combat spam and bots in general.","createdAt":"2018-03-07T20:34:09.913152Z","user":{"id":1524,"name":"dodgepong","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/1524/dodgepong","status":"active"},"hasVoted":false,"votesCount":8,"commentsCount":1,"status":"open","tags":[]},{"id":20427,"number":254,"title":"Add JIRA integration (on-premise)","slug":"add-jira-integration-on-premise","description":"","createdAt":"2020-04-24T14:46:31.912835Z","user":{"id":30757,"name":"Dominik","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/30757/Dominik","status":"active"},"hasVoted":false,"votesCount":3,"commentsCount":0,"status":"open","tags":[]},{"id":20341,"number":250,"title":"Milestone component similar GitHub","slug":"milestone-component-similar-github","description":"Milestone component similar GitHub","createdAt":"2020-04-21T04:29:41.538877Z","user":{"id":30573,"name":"Archive","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/30573/Archive","status":"active"},"hasVoted":false,"votesCount":4,"commentsCount":1,"status":"open","tags":[]},{"id":20275,"number":248,"title":"Alow microsoft login","slug":"alow-microsoft-login","description":"","createdAt":"2020-04-17T18:29:42.82881Z","user":{"id":30429,"name":"Peter","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/30429/Peter","status":"active"},"hasVoted":false,"votesCount":3,"commentsCount":1,"status":"open","tags":[]},{"id":16035,"number":205,"title":"Moderate the posts before making it live on the forum","slug":"moderate-the-posts-before-making-it-live-on-the-forum","description":"This would be really useful for us. Our audience is young. We need to moderate the content as more often than not the posts are inappropriate/irrelevant","createdAt":"2019-07-24T07:00:29.394591Z","user":{"id":3764,"name":"Shamil Gafoor","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/3764/Shamil%20Gafoor","status":"active"},"hasVoted":true,"votesCount":10,"commentsCount":1,"status":"open","tags":[]},{"id":3637,"number":94,"title":"Display summarize roadmap","slug":"display-summarize-roadmap","description":"Display summarize roadmap","createdAt":"2018-05-16T06:52:56.798402Z","user":{"id":3338,"name":"Juan Cruz","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/3338/Juan%20Cruz","status":"active"},"hasVoted":false,"votesCount":22,"commentsCount":4,"status":"open","tags":[]},{"id":5539,"number":112,"title":"Custom Fields: Single/Multi Selection or Free Text","slug":"custom-fields-single-multi-selection-or-free-text","description":"Custom fields would be a flexible solution to some requests we got before.\n\nA flag could be used to make it available on the main Form so that the users would be able to input it.\n\nExamples of custom fields would be:\n\n- **Category:** Feature Request, Bug, Partnership\n- **Product:** Platform, Website, Android App, iOS App","createdAt":"2018-07-24T20:07:49.088282Z","user":{"id":3,"name":"Guilherme Oenning","role":"administrator","avatarURL":"https://feedback.fider.io/avatars/gravatar/3/Guilherme%20Oenning","status":"active"},"hasVoted":true,"votesCount":20,"commentsCount":6,"status":"open","tags":[]},{"id":7699,"number":136,"title":"Disable Email Sign-Up","slug":"disable-email-sign-up","description":"As we now have the option to use custom OAuth providers I would like to prevent users from Signing-Up in any other way except OAuth.","createdAt":"2018-10-01T12:01:21.209401Z","user":{"id":917,"name":"Falk ","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/917/Falk%20","status":"active"},"hasVoted":true,"votesCount":33,"commentsCount":7,"status":"planned","response":{"text":"To be released on v0.19","respondedAt":"2019-11-03T08:30:48.754345Z","user":{"id":3,"name":"Guilherme Oenning","role":"administrator","avatarURL":"https://feedback.fider.io/avatars/gravatar/3/Guilherme%20Oenning","status":"active"},"original":null},"tags":[]},{"id":13251,"number":185,"title":"Webhook updates on events","slug":"webhook-updates-on-events","description":"It'd be neat if you could set a webhook URL to get updates (via POST request) for selected events. New posts, tags being added, new comments, etc.","createdAt":"2019-04-23T14:21:14.539233Z","user":{"id":16958,"name":"Sam","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/16958/Sam","status":"active"},"hasVoted":true,"votesCount":11,"commentsCount":2,"status":"open","tags":[]},{"id":19186,"number":233,"title":"Allow anonymous posts","slug":"allow-anonymous-posts","description":"Allow the admin to enable anonymous posts and votes. This is beneficial for internal private sites where sometimes having to attach a name to an idea can lead to less feedback.","createdAt":"2020-02-06T14:01:43.444436Z","user":{"id":28521,"name":"Rohit Gohri","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/28521/Rohit%20Gohri","status":"active"},"hasVoted":false,"votesCount":4,"commentsCount":2,"status":"open","tags":[]},{"id":42,"number":14,"title":"Allow visitors to post without having to sign in","slug":"allow-visitors-to-post-without-having-to-sign-in","description":"This would help the forums to get more contribution, but we'll need to think about using an anti-spam system.","createdAt":"2017-08-07T20:27:16.96248Z","user":{"id":3,"name":"Guilherme Oenning","role":"administrator","avatarURL":"https://feedback.fider.io/avatars/gravatar/3/Guilherme%20Oenning","status":"active"},"hasVoted":true,"votesCount":38,"commentsCount":18,"status":"open","response":{"text":"We're planning to have this feature in a near future release. Please come along and share your thoughts on how would you like to see implemented!","respondedAt":"2017-11-26T20:23:07.141281Z","user":{"id":3,"name":"Guilherme Oenning","role":"administrator","avatarURL":"https://feedback.fider.io/avatars/gravatar/3/Guilherme%20Oenning","status":"active"},"original":null},"tags":["effort-hard","impact-big","under-discussion"]},{"id":2182,"number":82,"title":"Allow users to mention/tag other users","slug":"allow-users-to-mention-tag-other-users","description":"Sometimes, users wish to be able to tag other users in a conversation as a means of replying or referring to someone else's comment. It would be nice if users could do so, perhaps by typing @ and then showing an auto-complete list of users to \"tag\".\n\nThis would go well with the [threaded replies](https://feedback.fider.io/ideas/16/threaded-comments-on-ideas) idea posted a while ago, though not strictly related.","createdAt":"2018-04-03T14:38:32.284695Z","user":{"id":1524,"name":"dodgepong","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/1524/dodgepong","status":"active"},"hasVoted":true,"votesCount":32,"commentsCount":3,"status":"open","tags":["effort-hard","impact-big"]},{"id":18493,"number":227,"title":"possibility to edit or delete my own idea","slug":"possibility-to-edit-or-delete-my-own-idea","description":"possibility to edit or delete my own idea","createdAt":"2019-12-13T14:41:46.541894Z","user":{"id":26479,"name":"Dorothy Devaux","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/26479/Dorothy%20Devaux","status":"active"},"hasVoted":false,"votesCount":14,"commentsCount":3,"status":"open","tags":[]},{"id":18145,"number":223,"title":"Display referenced posts.","slug":"display-referenced-posts","description":"Display referenced posts similar Github.","createdAt":"2019-11-20T09:42:47.290836Z","user":{"id":26751,"name":"Archive","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/26751/Archive","status":"active"},"hasVoted":false,"votesCount":7,"commentsCount":1,"status":"open","tags":[]},{"id":18124,"number":221,"title":"Attach Files on Posts and Comments","slug":"attach-files-on-posts-and-comments","description":"Add option to attach max 10-20MB file. I prefer extend fider possibilities than limit to classic feedback page","createdAt":"2019-11-19T18:11:18.331355Z","user":{"id":26751,"name":"Archive","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/26751/Archive","status":"active"},"hasVoted":false,"votesCount":1,"commentsCount":0,"status":"open","tags":[]},{"id":18123,"number":220,"title":"Display number of pages similar Stackoverflow and Github","slug":"display-number-of-pages-similar-stackoverflow-and-github","description":"It's really like find end of universe with 'View more posts' in our feedback page\n\nCan you add option for choose to display number of pages within admin or user settings? so you can keep exist mode for interested users","createdAt":"2019-11-19T17:57:03.321964Z","user":{"id":26751,"name":"Archive","role":"visitor","avatarURL":"https://feedback.fider.io/avatars/gravatar/26751/Archive","status":"active"},"hasVoted":false,"votesCount":3,"commentsCount":0,"status":"open","tags":[]}],"tags":[{"id":364,"name":"effort: easy","slug":"effort-easy","color":"239600","isPublic":false},{"id":864,"name":"effort: hard","slug":"effort-hard","color":"CE3C10","isPublic":false},{"id":865,"name":"effort: medium","slug":"effort-medium","color":"C67A00","isPublic":false},{"id":867,"name":"impact: big","slug":"impact-big","color":"8351A7","isPublic":false},{"id":866,"name":"impact: small","slug":"impact-small","color":"8351A7","isPublic":false},{"id":2,"name":"under discussion","slug":"under-discussion","color":"FEDBB5","isPublic":true}]}`
		_, err = ctx.RunScript(`const result = doWork(`+firstArg+`, `+secondArg+`)`, "index.js") // any functions previously added to the context can be called
		if err != nil {
			panic(err)
		}
		val, err := ctx.RunScript("result", "index.js") // return a value in JavaScript back to Go
		if err != nil {
			panic(err)
		}
		fmt.Printf("addition result: %s", val)
	} else {
		os.Exit(cmd.RunServer(settings))
	}
}
